stages:
  - build
  - test
  - deploy

variables:
  SSH_PRIVATE_KEY: $SSH_PRIVATE_KEY
  SSH_USER: deployment
  SSH_HOST: tommyneumaier.at
  APP_NAME: leomail-backend

before_script:
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh

build:
  stage: build
  image: maven
  script:
    # List the directory structure
    - ls -la
    # Clean the local repository
    - cd app/leomail-backend
    - mvn dependency:purge-local-repository -DreResolve=false -DactTransitively=false
    # Build the application with detailed logs
    - mvn clean package -DskipTests -e -X
  artifacts:
    paths:
      - app/leomail-backend/target/*.jar

test:
  stage: test
  image: maven
  script:
    - cd app/leomail-backend
    - mvn test

deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk update && apk add openssh
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/deployment_key
    - chmod 600 ~/.ssh/deployment_key
    - eval $(ssh-agent -s)
    - ssh-add ~/.ssh/deployment_key
  script:
    - ls -a
    - scp -i ~/.ssh/deployment_key app/leomail-backend/target/${APP_NAME}.jar $SSH_USER@$SSH_HOST:/home/$SSH_USER/
    - ssh -i ~/.ssh/deployment_key $SSH_USER@$SSH_HOST 'pkill -f ${APP_NAME}.jar || true'
    - ssh -i ~/.ssh/deployment_key $SSH_USER@$SSH_HOST "nohup java -jar /home/$SSH_USER/${APP_NAME}.jar &"
  only:
    - dev
